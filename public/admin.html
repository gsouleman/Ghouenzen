<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | Al-Wasiyyah</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <script>
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.replace('/login.html');
        } else {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.role !== 'admin') {
                alert('Access Denied. Admins only.');
                window.location.replace('/');
            }
        }
    </script>
</head>

<body class="dashboard-page">

    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="logo">
                <span class="logo-icon">â˜ª</span>
                <span class="logo-text">Al-Wasiyyah Admin</span>
            </a>
            <div class="nav-links">
                <a href="/" class="nav-link">Home</a>
                <a href="/admin.html" class="nav-link active">Users</a>
                <a href="#" onclick="logout()" class="nav-link">Logout</a>
            </div>
        </div>
    </nav>

    <div class="dashboard">
        <div class="dashboard-container">
            <div class="dashboard-header">
                <div>
                    <h1>User Management</h1>
                    <p>Manage system users and access roles</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="openAddUserModal()">+ Add New User</button>
                </div>
            </div>

            <div class="table-wrapper">
                <table class="data-table" id="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Role</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <!-- Users will be populated here -->
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <!-- Add/Edit User Modal -->
    <div id="user-modal" class="modal"
        style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index: 2000; align-items:center; justify-content:center;">
        <div class="modal-content" style="background:white; padding: 2rem; width: 400px; max-width: 90%;">
            <h2 id="modal-title" style="margin-bottom: 1.5rem;">Add User</h2>
            <form id="user-form" onsubmit="handleUserSubmit(event)">
                <input type="hidden" id="user-id">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="full-name">
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="role">
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                        <option value="guest">Guest</option>
                    </select>
                </div>
                <div class="form-group" id="password-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                    <small style="color:red; display:none;" id="password-hint">Leave blank to keep existing</small>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toast" class="toast"></div>
    <script src="/js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', loadUsers);

        async function loadUsers() {
            try {
                const users = await apiGet('/api/users');
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '';

                users.forEach(user => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.full_name || '-'}</td>
                        <td><span style="padding: 2px 8px; background: ${getRoleColor(user.role)}; color: white; border-radius: 4px;">${user.role}</span></td>
                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="action-btn edit" onclick="editUser(${user.id}, '${user.username}', '${user.full_name || ''}', '${user.role}')">Edit</button>
                            <button class="action-btn" style="background:#555; color:white;" onclick="resetUserPassword(${user.id})">Reset PWD</button>
                            <button class="action-btn delete" onclick="deleteUser(${user.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        function getRoleColor(role) {
            switch (role) {
                case 'admin': return '#B80000'; // Red
                case 'user': return '#00823B';  // Green
                case 'guest': return '#505050'; // Grey
                default: return '#000';
            }
        }

        function openAddUserModal() {
            document.getElementById('modal-title').textContent = 'Add User';
            document.getElementById('user-id').value = '';
            document.getElementById('username').value = '';
            document.getElementById('username').disabled = false;
            document.getElementById('full-name').value = '';
            document.getElementById('role').value = 'user';
            document.getElementById('password').value = '';
            document.getElementById('password').required = true;
            document.getElementById('password-hint').style.display = 'none';
            document.getElementById('user-modal').style.display = 'flex';
        }

        function editUser(id, username, fullName, role) {
            document.getElementById('modal-title').textContent = 'Edit User';
            document.getElementById('user-id').value = id;
            document.getElementById('username').value = username;
            document.getElementById('username').disabled = true; // Cannot change username
            document.getElementById('full-name').value = fullName;
            document.getElementById('role').value = role;
            document.getElementById('password').value = '';
            document.getElementById('password').required = false; // Not required for edit
            document.getElementById('password-hint').style.display = 'block';
            document.getElementById('password-hint').textContent = 'Leave blank to keep existing password';
            document.getElementById('user-modal').style.display = 'flex';
        }

        function closeUserModal() {
            document.getElementById('user-modal').style.display = 'none';
        }

        async function handleUserSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            const username = document.getElementById('username').value;
            const full_name = document.getElementById('full-name').value;
            const role = document.getElementById('role').value;
            const password = document.getElementById('password').value;

            try {
                if (id) {
                    // Update
                    await apiPut(`/api/users/${id}`, { full_name, role });
                    // If password provided, reset it separately or handle in one go? 
                    // My backend separated reset-password, but I can add it if needed.
                    // Actually, let's keep it simple. If checking update doesn't support password, then ignore it or warn.
                    // The backend PUT /api/users/:id only updates full_name and role.
                    // For password reset, we have a separate endpoint.
                    if (password) {
                        await apiPost(`/api/users/${id}/reset-password`, { newPassword: password });
                    }
                    showToast('User updated successfully');
                } else {
                    // Create
                    await apiPost('/api/users', { username, password, full_name, role });
                    showToast('User created successfully');
                }
                closeUserModal();
                loadUsers();
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user? This will delete all their associated data.')) return;
            try {
                await apiDelete(`/api/users/${id}`);
                showToast('User deleted');
                loadUsers();
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function resetUserPassword(id) {
            const newPassword = prompt('Enter new password for this user:');
            if (!newPassword) return;
            try {
                await apiPost(`/api/users/${id}/reset-password`, { newPassword });
                showToast('Password reset successfully');
            } catch (err) {
                showToast(err.message, 'error');
            }
        }
    </script>
</body>

</html>