<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Will Document | Al-Wasiyyah</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .editable-section {
            position: relative;
        }

        .edit-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .edit-btn:hover {
            opacity: 1;
        }

        .editable-content {
            min-height: 1.5em;
        }

        .editable-content:focus {
            outline: 2px solid var(--gold);
            background: #fffef5;
            padding: 0.5rem;
            border-radius: 4px;
        }

        .creditor-statement-btn {
            background: var(--primary-light);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .creditor-statement-btn:hover {
            background: var(--primary);
        }

        @media print {

            .edit-btn,
            .creditor-statement-btn {
                display: none !important;
            }
        }

        /* Creditor Statement Styles */
        .statement-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 1rem;
        }

        .statement-overlay.active {
            display: flex;
        }

        .statement-container {
            background: white;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .statement-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: var(--bg-warm);
        }

        .statement-header h3 {
            margin: 0;
            color: var(--primary-dark);
        }

        .statement-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        .statement-body {
            padding: 2rem;
        }

        .statement-actions {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Print Statement Styles */
        .print-statement {
            font-family: var(--font-body);
            line-height: 1.8;
        }

        .print-statement .letterhead {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary);
        }

        .print-statement .letterhead h2 {
            color: var(--primary-dark);
            margin-bottom: 0.25rem;
        }

        .print-statement .date-line {
            text-align: right;
            margin-bottom: 2rem;
        }

        .print-statement .recipient {
            margin-bottom: 2rem;
        }

        .print-statement .subject {
            font-weight: 600;
            margin-bottom: 1.5rem;
            text-decoration: underline;
        }

        .print-statement .body-text {
            margin-bottom: 1.5rem;
            text-align: justify;
        }

        .print-statement .amount-box {
            background: var(--bg-warm);
            padding: 1rem;
            border-radius: 8px;
            margin: 1.5rem 0;
            border-left: 4px solid var(--gold);
        }

        .print-statement .amount-numeric {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-dark);
        }

        .print-statement .amount-words {
            font-style: italic;
            color: var(--text-medium);
        }

        .print-statement .confirmation-box {
            background: #fff9e6;
            padding: 1.5rem;
            border: 2px dashed var(--gold);
            border-radius: 8px;
            margin: 2rem 0;
        }

        .print-statement .confirmation-box h4 {
            margin-bottom: 1rem;
            color: var(--primary-dark);
        }

        .print-statement .confirm-line {
            display: flex;
            gap: 1rem;
            margin-bottom: 0.75rem;
            align-items: center;
        }

        .print-statement .confirm-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-dark);
            display: inline-block;
        }

        .print-statement .signature-area {
            margin-top: 3rem;
        }

        .print-statement .sig-line {
            border-bottom: 1px solid var(--text-dark);
            min-width: 200px;
            display: inline-block;
            margin-left: 1rem;
        }
    </style>
</head>

<body class="will-page">


    <nav class="navbar no-print">
        <div class="nav-container">
            <a href="/" class="logo">
                <span class="logo-icon">‚ò™</span>
                <span class="logo-text">Al-Wasiyyah</span>
            </a>
            <div class="nav-links">
                <a href="/" class="nav-link">Home</a>
                <a href="/dashboard" class="nav-link">Dashboard</a>
                <a href="/will" class="nav-link active">Will Document</a>
            </div>
        </div>
    </nav>

    <main class="will-main">
        <div class="will-container">
            <div class="will-actions no-print">
                <button class="btn btn-outline" onclick="window.print()">üñ®Ô∏è Print Will Document</button>
                <button class="btn btn-outline" onclick="saveWillEdits()">üíæ Save Edits</button>
                <a href="/dashboard" class="btn btn-primary">‚Üê Back to Dashboard</a>
            </div>

            <article class="will-document">
                <header class="will-header">
                    <div class="bismillah-header">ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê</div>
                    <h1>LAST WILL AND TESTAMENT</h1>
                    <p class="will-subtitle">Islamic Will (Al-Wasiyyah)</p>
                </header>

                <section class="will-section editable-section">
                    <button class="edit-btn no-print" onclick="toggleEdit('intro')">‚úèÔ∏è Edit</button>
                    <p class="will-intro">
                        This is the last will and testament of <strong id="will-name">_______________</strong>,
                        residing at <span id="will-address">_______________</span>,
                        being of sound mind and memory.
                    </p>
                    <div id="intro-extra" class="editable-content" contenteditable="false"
                        data-placeholder="Click edit to add additional introduction text..."></div>
                </section>

                <section class="will-section editable-section">
                    <button class="edit-btn no-print" onclick="toggleEdit('shahada')">‚úèÔ∏è Edit</button>
                    <h2>1. DECLARATION OF FAITH (Shahada)</h2>
                    <div id="shahada-content" class="editable-content" contenteditable="false">
                        <p>I bear witness that there is no god but Allah, and I bear witness that Muhammad (peace be
                            upon him) is His servant and messenger.</p>
                    </div>
                </section>

                <section class="will-section editable-section">
                    <button class="edit-btn no-print" onclick="toggleEdit('executors')">‚úèÔ∏è Edit</button>
                    <h2>2. APPOINTMENT OF EXECUTOR(S)</h2>
                    <p>I appoint the following person(s) as the executor(s) of my will:</p>
                    <ul id="will-executors">
                        <li><em>No executors designated</em></li>
                    </ul>
                    <div id="executors-extra" class="editable-content" contenteditable="false"
                        data-placeholder="Click edit to add additional executor instructions..."></div>
                    <p>They are to act with justice, in consultation with a qualified Islamic scholar, to ensure the
                        execution of my will according to Islamic law (Shariah).</p>
                </section>

                <section class="will-section editable-section">
                    <button class="edit-btn no-print" onclick="toggleEdit('debts')">‚úèÔ∏è Edit</button>
                    <h2>3. SETTLEMENT OF DEBTS AND OBLIGATIONS</h2>
                    <div id="debts-content" class="editable-content" contenteditable="false">
                        <p class="emphasis">MY FIRST AND BINDING INSTRUCTION is that all my lawful debts and obligations
                            must be settled fully from my estate before any distribution to heirs.</p>
                        <p>The attached "Estate Management Worksheet" forms an integral part of this will.</p>
                        <p>My executors must:</p>
                        <ol type="a">
                            <li>Identify, verify, and pay all creditors from <strong>Section B</strong></li>
                            <li>Collect all debts owed to me from <strong>Section A</strong></li>
                            <li><strong>LIQUIDATE (SELL)</strong> assets from <strong>Section C</strong> to settle debts
                            </li>
                        </ol>
                        <p class="emphasis">THE PRIORITY IS THE COMPLETE ELIMINATION OF DEBT FROM THE ESTATE.</p>
                    </div>
                </section>

                <section class="will-section editable-section">
                    <button class="edit-btn no-print" onclick="toggleEdit('bequests')">‚úèÔ∏è Edit</button>
                    <h2>4. BEQUESTS (Wasiyyah)</h2>
                    <div id="bequests-content" class="editable-content" contenteditable="false">
                        <p>After the full settlement of all debts, a bequest of <strong>NOT EXCEEDING ONE-THIRD
                                (1/3)</strong> of the remaining net estate may be made to non-heirs as specified below:
                        </p>
                        <div class="blank-line">Beneficiary: _______________________________________________</div>
                        <p class="note"><em>If no bequest is specified above, this clause is void.</em></p>
                    </div>
                </section>

                <section class="will-section editable-section">
                    <button class="edit-btn no-print" onclick="toggleEdit('distribution')">‚úèÔ∏è Edit</button>
                    <h2>5. DISTRIBUTION OF RESIDUAL ESTATE (Al-Faraid)</h2>
                    <p class="emphasis">ONLY AFTER the full settlement of debts and any valid bequest, the remainder
                        shall be distributed among my legal heirs according to Islamic laws of inheritance (Al-Faraid).
                    </p>
                    <p>My known heirs at the time of this will are:</p>
                    <div class="heirs-box" id="will-heirs">
                        <p><em>No heirs registered</em></p>
                    </div>
                    <div id="distribution-extra" class="editable-content" contenteditable="false"
                        data-placeholder="Click edit to add additional distribution instructions..."></div>
                    <p>The specific shares shall be calculated by a qualified Islamic legal authority based on the
                        <strong>NET ESTATE VALUE</strong>.</p>
                </section>

                <section class="will-section editable-section">
                    <button class="edit-btn no-print" onclick="toggleEdit('general')">‚úèÔ∏è Edit</button>
                    <h2>6. GENERAL INSTRUCTIONS</h2>
                    <div id="general-content" class="editable-content" contenteditable="false">
                        <p>I request my heirs to resolve matters amicably and fear Allah in their dealings.</p>
                        <p>My executors are authorized to incur necessary expenses for the execution of this will.</p>
                    </div>
                </section>

                <section class="will-section signatures">
                    <h2>SIGNATURES</h2>
                    <div class="signature-block">
                        <div class="sig-row"><span>Testator:</span><span class="sig-line"></span></div>
                        <div class="sig-row"><span>Date:</span><span class="sig-line">_____ / _____ / _______</span>
                        </div>
                    </div>
                    <div class="witnesses">
                        <div class="witness">
                            <h4>Witness 1:</h4>
                            <div class="sig-row"><span>Name:</span><span class="sig-line"></span></div>
                            <div class="sig-row"><span>Signature:</span><span class="sig-line"></span></div>
                        </div>
                        <div class="witness">
                            <h4>Witness 2:</h4>
                            <div class="sig-row"><span>Name:</span><span class="sig-line"></span></div>
                            <div class="sig-row"><span>Signature:</span><span class="sig-line"></span></div>
                        </div>
                    </div>
                </section>

                <section class="will-section worksheets">
                    <h2>ATTACHED: Estate Management Worksheet</h2>

                    <div class="worksheet">
                        <h3>Section A: Debtors (People Who Owe the Estate)</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Name</th>
                                    <th>Reason</th>
                                    <th>Amount (XAF)</th>
                                </tr>
                            </thead>
                            <tbody id="will-debtors">
                                <tr>
                                    <td colspan="4"><em>No debtors</em></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3"><strong>Total to Collect:</strong></td>
                                    <td id="will-debtors-total"><strong>0 XAF</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="worksheet">
                        <h3>Section B: Creditors (Debts of the Estate) <span class="no-print"
                                style="font-size: 0.8rem; color: var(--text-light);">‚Äî Click on creditor name to
                                generate statement</span></h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Name</th>
                                    <th>Reason</th>
                                    <th>Amount (XAF)</th>
                                    <th class="no-print">Statement</th>
                                </tr>
                            </thead>
                            <tbody id="will-creditors">
                                <tr>
                                    <td colspan="5"><em>No creditors</em></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3"><strong>Total Liabilities:</strong></td>
                                    <td id="will-creditors-total"><strong>0 XAF</strong></td>
                                    <td class="no-print"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="worksheet">
                        <h3>Section C: Assets to be Liquidated for Debt</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Description</th>
                                    <th>Location</th>
                                    <th>Value (XAF)</th>
                                </tr>
                            </thead>
                            <tbody id="will-assets">
                                <tr>
                                    <td colspan="4"><em>No assets for liquidation</em></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3"><strong>Total Liquidation Value:</strong></td>
                                    <td id="will-assets-total"><strong>0 XAF</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="worksheet">
                        <h3>Section D: Reserved Assets (Not to be Liquidated)</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Description</th>
                                    <th>Location</th>
                                    <th>Value (XAF)</th>
                                </tr>
                            </thead>
                            <tbody id="will-assets-reserved">
                                <tr>
                                    <td colspan="4"><em>No reserved assets</em></td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3"><strong>Total Reserved Value:</strong></td>
                                    <td id="will-assets-reserved-total"><strong>0 XAF</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <div class="worksheet calculation">
                        <h3>Section E: Net Estate Calculation</h3>
                        <table class="calc-table">
                            <tr>
                                <td>A. Total Estate Value</td>
                                <td id="will-calc-a">0 XAF</td>
                            </tr>
                            <tr>
                                <td>B. Total from Debtors</td>
                                <td id="will-calc-b">+ 0 XAF</td>
                            </tr>
                            <tr class="subtotal">
                                <td>C. Available Pool (A + B)</td>
                                <td id="will-calc-c">0 XAF</td>
                            </tr>
                            <tr>
                                <td>D. Total Liabilities</td>
                                <td id="will-calc-d">- 0 XAF</td>
                            </tr>
                            <tr class="final">
                                <td><strong>E. NET ESTATE FOR DISTRIBUTION</strong></td>
                                <td id="will-calc-e"><strong>0 XAF</strong></td>
                            </tr>
                        </table>
                    </div>

                    <div class="worksheet">
                        <h3>Islamic Inheritance Distribution</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Heir</th>
                                    <th>Relation</th>
                                    <th>Share</th>
                                    <th>Amount (XAF)</th>
                                </tr>
                            </thead>
                            <tbody id="will-inheritance">
                                <tr>
                                    <td colspan="4"><em>Calculated based on net estate</em></td>
                                </tr>
                            </tbody>
                        </table>
                        <p class="worksheet-note"><em>Final distribution must be verified by a qualified Islamic
                                scholar.</em></p>
                    </div>
                </section>

                <footer class="will-footer">
                    <p>Document generated by Al-Wasiyyah Islamic Will & Estate Management System</p>
                    <p>Generated on: <span id="will-date"></span></p>
                </footer>
            </article>
        </div>
    </main>

    <!-- Creditor Statement Modal -->
    <div class="statement-overlay" id="statement-overlay">
        <div class="statement-container">
            <div class="statement-header">
                <h3>üìÑ Creditor Confirmation Statement</h3>
                <button class="statement-close" onclick="closeStatement()">√ó</button>
            </div>
            <div class="statement-body" id="statement-body"></div>
            <div class="statement-actions no-print">
                <button class="btn btn-outline" onclick="closeStatement()">Close</button>
                <button class="btn btn-primary" onclick="printStatement()">üñ®Ô∏è Print Statement</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script src="/js/app.js"></script>
    <script>
        let willEdits = {};
        let testatorData = {};
        let creditorsData = [];

        document.addEventListener('DOMContentLoaded', loadWillData);

        async function loadWillData() {
            document.getElementById('will-date').textContent = new Date().toLocaleDateString('en-GB', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            // Load saved edits from database
            await loadWillEdits();

            try {
                const summaryRes = await fetch('/api/summary');
                if (!summaryRes.ok) return;
                const summary = await summaryRes.json();

                testatorData = summary.testator;
                document.getElementById('will-name').textContent = summary.testator.full_name || '_______________';
                document.getElementById('will-address').textContent = summary.testator.address || '_______________';

                const t = summary.totals;
                document.getElementById('will-calc-a').textContent = formatCurrencyFull(t.assets);
                document.getElementById('will-calc-b').textContent = '+ ' + formatCurrencyFull(t.debtors);
                document.getElementById('will-calc-c').textContent = formatCurrencyFull(t.total_pool);
                document.getElementById('will-calc-d').textContent = '- ' + formatCurrencyFull(t.creditors);
                document.getElementById('will-calc-e').innerHTML = '<strong>' + formatCurrencyFull(t.net_estate) + '</strong>';
                document.getElementById('will-debtors-total').innerHTML = '<strong>' + formatCurrencyFull(t.debtors) + '</strong>';
                document.getElementById('will-creditors-total').innerHTML = '<strong>' + formatCurrencyFull(t.creditors) + '</strong>';
                document.getElementById('will-assets-total').innerHTML = '<strong>' + formatCurrencyFull(t.assets) + '</strong>';

                await loadExecutors();
                await loadHeirs();
                await loadDebtors();
                await loadCreditors();
                await loadAssets();
                loadInheritance(summary.inheritance);
            } catch (err) {
                console.error('Error loading will data:', err);
            }
        }

        function formatCurrencyFull(amount) {
            if (amount === null || amount === undefined || amount === 0) return '0 XAF';
            return new Intl.NumberFormat('fr-FR').format(Math.round(amount)) + ' XAF';
        }

        function numberToWords(num) {
            if (num === 0) return 'zero';

            const ones = ['', 'one', 'two', 'three', 'four', 'five', 'six', 'seven', 'eight', 'nine',
                'ten', 'eleven', 'twelve', 'thirteen', 'fourteen', 'fifteen', 'sixteen',
                'seventeen', 'eighteen', 'nineteen'];
            const tens = ['', '', 'twenty', 'thirty', 'forty', 'fifty', 'sixty', 'seventy', 'eighty', 'ninety'];
            const scales = ['', 'thousand', 'million', 'billion'];

            function convertGroup(n) {
                if (n === 0) return '';
                if (n < 20) return ones[n];
                if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 ? '-' + ones[n % 10] : '');
                return ones[Math.floor(n / 100)] + ' hundred' + (n % 100 ? ' and ' + convertGroup(n % 100) : '');
            }

            let result = '';
            let scaleIndex = 0;
            num = Math.abs(Math.round(num));

            while (num > 0) {
                const group = num % 1000;
                if (group !== 0) {
                    const groupStr = convertGroup(group);
                    result = groupStr + (scales[scaleIndex] ? ' ' + scales[scaleIndex] : '') + (result ? ' ' + result : '');
                }
                num = Math.floor(num / 1000);
                scaleIndex++;
            }

            return result.trim();
        }

        function formatAmountWithWords(amount) {
            const numeric = formatCurrencyFull(amount);
            const words = numberToWords(amount);
            return {
                numeric: numeric,
                words: words.charAt(0).toUpperCase() + words.slice(1) + ' CFA Francs'
            };
        }

        async function loadExecutors() {
            const res = await fetch('/api/executors');
            const data = await res.json();
            const el = document.getElementById('will-executors');
            if (data.length > 0) {
                el.innerHTML = data.map((e, i) => `<li><strong>Executor ${i + 1}:</strong> ${e.full_name}${e.contact ? ' - ' + e.contact : ''}</li>`).join('');
            }
        }

        async function loadHeirs() {
            const res = await fetch('/api/heirs');
            const data = await res.json();
            const el = document.getElementById('will-heirs');
            if (data.length > 0) {
                el.innerHTML = '<ul>' + data.map(h => `<li><strong>${capitalize(h.relation)}:</strong> ${h.full_name}</li>`).join('') + '</ul>';
            }
        }

        async function loadDebtors() {
            const res = await fetch('/api/debtors');
            const data = await res.json();
            const el = document.getElementById('will-debtors');
            if (data.length > 0) {
                el.innerHTML = data.map((d, i) => `<tr><td>${i + 1}</td><td>${d.full_name}</td><td>${d.reason || '-'}</td><td>${formatCurrencyFull(d.amount)}</td></tr>`).join('');
            }
        }

        async function loadCreditors() {
            const res = await fetch('/api/creditors');
            const data = await res.json();
            creditorsData = data;
            const el = document.getElementById('will-creditors');
            if (data.length > 0) {
                el.innerHTML = data.map((c, i) => `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${c.full_name}</td>
                        <td>${c.reason || '-'}</td>
                        <td>${formatCurrencyFull(c.amount)}</td>
                        <td class="no-print">
                            <button class="creditor-statement-btn" onclick="showCreditorStatement(${c.id})">üìÑ Statement</button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        async function loadAssets() {
            const res = await fetch('/api/assets');
            const data = await res.json();

            // Filter assets
            const liquidated = data.filter(a => a.is_liquidated !== false);
            const reserved = data.filter(a => a.is_liquidated === false);

            // Render Liquidated
            const elLiq = document.getElementById('will-assets');
            if (liquidated.length > 0) {
                elLiq.innerHTML = liquidated.map((a, i) => `<tr><td>${i + 1}</td><td>${a.description}</td><td>${a.location || '-'}</td><td>${formatCurrencyFull(a.estimated_value)}</td></tr>`).join('');
            } else {
                elLiq.innerHTML = '<tr><td colspan="4"><em>No assets for liquidation</em></td></tr>';
            }
            // Update liquidated total explicitly (though summary has it, we can recalc or leave it if all are 0)
            // But summary.totals.assets includes ALL. If non-liquidated are 0, then summary.totals.assets == liquidated total.
            // So will-assets-total (populated from summary) is correct.

            // Render Reserved
            const elRes = document.getElementById('will-assets-reserved');
            if (reserved.length > 0) {
                elRes.innerHTML = reserved.map((a, i) => `<tr><td>${i + 1}</td><td>${a.description}</td><td>${a.location || '-'}</td><td>${formatCurrencyFull(a.estimated_value)}</td></tr>`).join('');
            } else {
                elRes.innerHTML = '<tr><td colspan="4"><em>No reserved assets</em></td></tr>';
            }
            // Calc reserved total (should be 0 based on logic, but let's sum just in case)
            const reservedTotal = reserved.reduce((s, a) => s + (parseFloat(a.estimated_value) || 0), 0);
            document.getElementById('will-assets-reserved-total').innerHTML = '<strong>' + formatCurrencyFull(reservedTotal) + '</strong>';
        }

        function loadInheritance(inheritance) {
            const el = document.getElementById('will-inheritance');
            if (inheritance && inheritance.shares && inheritance.shares.length > 0) {
                el.innerHTML = inheritance.shares.map(s => `<tr><td>${s.name}</td><td>${s.relation}</td><td>${s.fraction}</td><td>${formatCurrencyFull(s.amount)}</td></tr>`).join('');
            }
        }

        function capitalize(str) {
            return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
        }

        // Editable sections
        function toggleEdit(section) {
            const contentEl = document.getElementById(section + '-content') || document.getElementById(section + '-extra');
            if (!contentEl) return;

            const isEditing = contentEl.contentEditable === 'true';
            contentEl.contentEditable = !isEditing;

            if (isEditing) {
                contentEl.style.outline = '';
                contentEl.style.background = '';
                willEdits[section] = contentEl.innerHTML;
            } else {
                contentEl.focus();
            }
        }

        async function saveWillEdits() {
            // Collect all editable content
            const sections = ['intro', 'shahada', 'executors', 'debts', 'bequests', 'distribution', 'general'];
            sections.forEach(section => {
                const contentEl = document.getElementById(section + '-content') || document.getElementById(section + '-extra');
                if (contentEl && contentEl.innerHTML.trim()) {
                    willEdits[section] = contentEl.innerHTML;
                }
            });

            try {
                await fetch('/api/will-edits', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ edits: willEdits })
                });
                showToast('Will document edits saved!', 'success');
            } catch (err) {
                showToast('Error saving edits', 'error');
            }
        }

        async function loadWillEdits() {
            try {
                const res = await fetch('/api/will-edits');
                if (res.ok) {
                    const data = await res.json();
                    willEdits = data.edits || {};

                    // Apply saved edits
                    Object.keys(willEdits).forEach(section => {
                        const contentEl = document.getElementById(section + '-content') || document.getElementById(section + '-extra');
                        if (contentEl && willEdits[section]) {
                            contentEl.innerHTML = willEdits[section];
                        }
                    });
                }
            } catch (err) {
                console.log('No saved edits found');
            }
        }

        // Creditor Statement Functions
        function showCreditorStatement(creditorId) {
            const creditor = creditorsData.find(c => c.id === creditorId);
            if (!creditor) return;

            const today = new Date().toLocaleDateString('en-GB', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            const amountFormatted = formatAmountWithWords(creditor.amount);
            const title = creditor.full_name.toUpperCase().startsWith('MR') ||
                creditor.full_name.toUpperCase().startsWith('MRS') ||
                creditor.full_name.toUpperCase().startsWith('MS') ? '' : 'Mr./Mrs. ';

            const statementHTML = `
                <div class="print-statement" id="printable-statement">
                    <div class="letterhead">
                        <h2>DEBT CONFIRMATION STATEMENT</h2>
                        <p>Al-Wasiyyah Estate Management</p>
                    </div>

                    <div class="date-line">
                        <strong>Date:</strong> ${today}
                    </div>

                    <div class="recipient">
                        <p><strong>To:</strong> ${title}${creditor.full_name}</p>
                        ${creditor.contact ? `<p><strong>Contact:</strong> ${creditor.contact}</p>` : ''}
                    </div>

                    <div class="subject">
                        Subject: Confirmation of Outstanding Debt
                    </div>

                    <div class="body-text">
                        <p>Dear ${title}${creditor.full_name},</p>
                        
                        <p>This letter serves as a formal acknowledgment and statement of the debt that I, 
                        <strong>${testatorData.full_name || '[Testator Name]'}</strong>, 
                        residing at <strong>${testatorData.address || '[Address]'}</strong>, 
                        owe to you as of the date indicated above.</p>

                        <p>${creditor.reason ? `<strong>Reason for debt:</strong> ${creditor.reason}` : ''}</p>
                    </div>

                    <div class="amount-box">
                        <p><strong>Amount Owed:</strong></p>
                        <p class="amount-numeric">${amountFormatted.numeric}</p>
                        <p class="amount-words">(${amountFormatted.words} Only)</p>
                    </div>

                    <div class="body-text">
                        <p>This is what I owe to ${title}${creditor.full_name} as of this date (${today}).</p>
                        
                        <p>I kindly request that you review this statement and confirm its accuracy. 
                        If there are any discrepancies, omissions, or additional amounts that should be included, 
                        please indicate them in the section below.</p>
                    </div>

                    <div class="confirmation-box">
                        <h4>CREDITOR'S CONFIRMATION</h4>
                        <p>Please tick the appropriate box and sign below:</p>
                        
                        <div class="confirm-line">
                            <span class="confirm-checkbox"></span>
                            <span>I confirm that the amount stated above (<strong>${amountFormatted.numeric}</strong>) is correct and complete.</span>
                        </div>
                        
                        <div class="confirm-line">
                            <span class="confirm-checkbox"></span>
                            <span>The amount stated is incorrect. The correct amount is: __________________ XAF</span>
                        </div>
                        
                        <div class="confirm-line">
                            <span class="confirm-checkbox"></span>
                            <span>There are additional amounts/items not included. Details: </span>
                        </div>
                        <p style="border-bottom: 1px solid #333; min-height: 60px; margin-top: 0.5rem;"></p>

                        ${creditor.notes ? `<p style="margin-top: 1rem;"><strong>Additional Notes from Debtor:</strong> ${creditor.notes}</p>` : ''}
                    </div>

                    <div class="signature-area">
                        <p><strong>Creditor's Signature:</strong> <span class="sig-line"></span></p>
                        <p style="margin-top: 1rem;"><strong>Date:</strong> <span class="sig-line"></span></p>
                        <p style="margin-top: 1rem;"><strong>Contact Number:</strong> <span class="sig-line"></span></p>
                    </div>

                    <div style="margin-top: 3rem; padding-top: 1rem; border-top: 1px solid #ccc; font-size: 0.85rem; color: #666;">
                        <p><em>This document is generated for estate planning purposes as part of the preparation of an Islamic Will (Al-Wasiyyah). 
                        Please return the signed copy to the testator or their designated executor.</em></p>
                    </div>
                </div>
            `;

            document.getElementById('statement-body').innerHTML = statementHTML;
            document.getElementById('statement-overlay').classList.add('active');
        }

        function closeStatement() {
            document.getElementById('statement-overlay').classList.remove('active');
        }

        function printStatement() {
            const printContent = document.getElementById('printable-statement').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Creditor Statement</title>
                    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        * { box-sizing: border-box; margin: 0; padding: 0; }
                        body { font-family: 'Outfit', sans-serif; padding: 2rem; line-height: 1.8; color: #1a1a1a; }
                        .letterhead { text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #1a6b52; }
                        .letterhead h2 { color: #0d4d3a; margin-bottom: 0.25rem; }
                        .date-line { text-align: right; margin-bottom: 2rem; }
                        .recipient { margin-bottom: 2rem; }
                        .subject { font-weight: 600; margin-bottom: 1.5rem; text-decoration: underline; }
                        .body-text { margin-bottom: 1.5rem; text-align: justify; }
                        .amount-box { background: #f5f0e6; padding: 1rem; border-radius: 8px; margin: 1.5rem 0; border-left: 4px solid #c9a227; }
                        .amount-numeric { font-size: 1.25rem; font-weight: 700; color: #0d4d3a; }
                        .amount-words { font-style: italic; color: #4a4a4a; }
                        .confirmation-box { background: #fff9e6; padding: 1.5rem; border: 2px dashed #c9a227; border-radius: 8px; margin: 2rem 0; }
                        .confirmation-box h4 { margin-bottom: 1rem; color: #0d4d3a; }
                        .confirm-line { display: flex; gap: 1rem; margin-bottom: 0.75rem; align-items: flex-start; }
                        .confirm-checkbox { width: 18px; height: 18px; border: 2px solid #1a1a1a; display: inline-block; flex-shrink: 0; margin-top: 4px; }
                        .signature-area { margin-top: 3rem; }
                        .sig-line { border-bottom: 1px solid #1a1a1a; min-width: 200px; display: inline-block; margin-left: 1rem; }
                        @media print { body { padding: 1rem; } }
                    </style>
                </head>
                <body>${printContent}</body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Close modal on overlay click or Escape
        document.getElementById('statement-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'statement-overlay') closeStatement();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeStatement();
        });
    </script>
</body>

</html>